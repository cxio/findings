# P2P:UDP-NAPT穿透协助

> STUN: Session Traversal Utilities for NAT

借助于findings公共服务网络，实现内网节点对自身NAT类型和公网IP:Port的检测。

内网节点连入findings网络可借助于自身运行一个findings服务器，当findings服务器与外部findings网络连接组网后，即可通过该服务器连入外部findings网络，获得需要的外部findings节点信息。


## 节点分类

一台连入公网的节点可能是直接的公网客户机，也可能是内网中通过网关NAT连入公网的局域网客户机。公网客户机可以直接接收任意来源的连入请求，但内网客户机就不一定了，它与NAT网关对内部客户机的连接处理方式有关。总的来说，一台连入公网的客户机可分为如下几种节点类型。

1. `Pub0/Public`：公共域节点。直接连在公网上，拥有自己的公网IP。端口自由（标准端口、动态可预测的端口）。
2. `Pub1/Public@UPnP`：准公共域节点。可通过简单的UPnP映射到公网，连入不受NAT制约，端口由UPnP映射配置。
3. `FullC/Full Cone`：完全圆锥型节点。最宽松的一种NAT约束，网关不对来源IP和Port作限制，接收任意连入数据包，类似公共域节点（注：这类实际部署不多）。
4. `RC/Restricted Cone`：受限圆锥型节点。NAT网关要求连入来源IP需与连出目标IP相同，不限制端口。注：不同来源IP的数据包会被丢弃。
5. `P-RC/Port Restricted Cone`：端口受限圆锥型节点。NAT网关要求连入来源的IP和Port与连出时目标的IP和Port都相同，内网主机连出端口号分配后基本不变。
6. `Sym/Symmetric NAT`：NAT对称型节点。内网主机连出的每一个不同目标分配一个不同的端口号。这种目标级粒度的动态端口号策略无法被打洞。

以上类型的节点从前至后可连接性逐渐降低，前三种区别不大，后3种逐级变差。

> **注记：**
> 如果一个 `Sym` 节点连入网络，它可以协助判断 `FullC` 类型节点：作为不同的IP和Port资源。


## 类型检测

检测指令共3个，按顺序进行。


### 1. `STUN:Info`

获取本节点的外网信息，包含IP和端口。这是最基本的请求类型，也决定后续检测过程是否需要继续。

随机选择2-3台服务器，向它们发送 `STUN:Info` 请求，根据回应判断：

1. 如果无返回信息，表示网络故障或UDP协议被路由屏蔽，失败结束。
2. 如果两个服务器返回的值不同，则为 `Sym` 类型。检测结束。
3. 两个返回值相同且端口号与UPnP映射相同，则很可能为 `Pub1` 类型。跳到第3步 `STUN:NewHost` 确认，否则进入下一步检测。


### 2. `STUN:NewPort`

该步骤检测客户端为 `P-RC` 及以上（`RC`, `FullC`）类型。

客户端向之前联系的服务器发送 `STUN:NewPort` 请求，根据回应判断：

1. 未收到回应则为 `P-RC` 类型。
2. 收到回应则为 `RC` 或 `FullC` 类型。


### 3. `STUN:NewHost`

该步骤检测客户端是否为 `FullC` 及以上（`Pub1`）类型。

客户端构造一个身份标识，向之前联系的服务器发送 `STUN:NewHost` 请求（包含身份标识），请求对端连系其它服务器发送包含身份标识的探测包。

1. 如果收到包含正确身份标识的回应，则为 `FullC` 类型（从第2步来）或 `Pub1` 类型（从第1步来）。
2. 如果未收到回应且由第1步跳过来，则返回执行第2步测试。否则节点止于 `RC` 类型。

**实现注记：**

- 服务器选择新的协助主机时，为充分利用资源，可以选择连接池中的 `Sym` 或 `P-RC` 类型。
- 服务器可能向多个主机发出协助探测请求（如2-3个），客户端应记住已连接过的服务器，以便排除它们的回应（碰撞概率很低）。
- 服务器会向客户端确认发送的协助请求数量，0值表示无法协助。

> **注：**
> 直接拥有公网IP的节点（Pub0）无需检测，由本地配置即可知道。
> 极低的概率可能导致 FullC 与 Pub1 无法区分（FullC分配的端口号正好与UPnP配置相同），不过这不重要。


## 打洞与连接

当节点知道彼此的NAT类型和IP:Port后，按如下规则进行打洞和连接。


### 1. `Sym -> RC`

对称型节点只能连出，无法打洞接受主动连入，因此最低只能和 RC 建立连接，由 RC 向 Sym 方向打洞，目标端口任意。


### 2. `P-RC -> P-RC, RC`

端口受限圆锥型节点可以与同类节点连接，当然也可以与 RC 类型连接。遵循**请求端打洞，对端连入**的通行规则。


### 3. `RC -> P-RC, RC`

受限圆锥型节点可以与同类节点和 P-RC 类型节点连接。打洞规则如前。


### 消息包

消息包用于双方的打洞-连接沟通，它由findings网络上相互协作的服务器传送。

```go
stunMessage {
    Flag    byte // NAT 类型，打洞请求标识
    IP      IP   // 公网IP
    Port    int  // 公网端口
    Token   int  // 身份标识，4字节随机数（由对端原样返回）
}
