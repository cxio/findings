# STUN 服务设计

> STUN: Session Traversal Utilities for NAT

借助于Findings公共网络，NAT内网节点可以探知自身的NAT类型、公网映射地址，并请求UDP打洞协助等。


## NAT 类型

一台连入公网的节点可能是直接的公网主机，也可能是内网中通过网关连入公网的内网主机。

公网主机可接收任意来源的连入请求，但内网主机就不一定了，这与网关的NAT映射方式有关，即NAT类型。

- `Full Cone`：完全圆锥型（`FullC`）。最宽松的一种NAT约束，网关不对来源IP:Port作任何限制，可接收任意地址的连入。
- `Restricted Cone`：受限圆锥型（`RC`）。连入的源IP需与连出时的目标IP相同，不限制端口。
- `Port Restricted Cone`：端口受限圆锥型（`P-RC`）。除了IP要一致外，连入的源Port必须就是连出的目标Port。
- `Symmetric`：对称型（`Sym`）。内网主机连出的每一个不同目标都会新建一个不同的NAT映射。

另外还有几个不属于NAT但与UDP通讯/打洞有关的网域类型：

- `UDP Firewall`：有UDP防火墙。仅主动连出的目标可以与内网节点通讯，即：先有连出，后可连入。
- `UDP Blocked`：UDP禁用。完全不提供UDP协议的通讯，全面禁用。
- `Open Internet`：开放网络（`Pub`）。没有任何约束的公网地址，支持任何连入。


### 可连通性

公网 `Pub` 和 `FullC` 类型几乎一样，可以接受任意节点的连入。但 `FullC` 类型通常部署很少。

对称型 `Sym` 对每个目标的NAT映射都不同，基本无法从第三方获得映射地址，所以也很难执行打洞操作。`Sym` 类型只能单向连入 `Pub` 或 `FullC` 类型（合称 `Pub/FullC`）节点。

`RC` 有稍为宽松的约束，`UDP Firewall` 则和 `P-RC` 相似，只要先发出了请求，就可以接受目标的回应。也即这三种类型都可以用打洞的方式创建连接。

至于 `UDP Blocked` 禁用UDP的网域，则完全无法使用 UDP 通讯了。

> **注：**
> 一个仅受限于家庭网关的公网节点可通过 UPnP 映射可成为公网节点。



## NAT 类型探测

如果客户端已经获得了多个Findings公网节点的信息，就可以向这些节点拨号连接并请求NAT相关服务。

> **注：**
> 直接接受外部连入的Findings节点只能是 `Pub/FullC` 类型，统称公网节点。


### 预探测

节点首先应当确认自己是否位于 UDP 被封禁的网域：从同一个本地端口向2个Findings公网节点尝试 QUIC 连接。

如果连接成功，则进入下一步，否则大概率 UDP 被封（`UDP Blocked`），NAT 探测无意义。

> **可靠性增强：**
> 如果无法创建 QUIC 连接，可再向2台服务器尝试。如果再失败，则基本确认UDP封禁。
> 如果有一台连接成功，则可继续尝试，直到创建第二个连接。
>
> 另外，如果节点已经TCP连接到服务器，可直接请求其UDP监听地址并尝试（服务器确定在线）。

向服务器请求获取自身 UDP 地址，然后对比：

- 不同：为 `Sym` 类型，探测结束。
- 相同：再与本地地址（LocalAddr）对比：
    - 不同（N）：待进一步测试……
    - 相同（Y）：`Open Internet` | `UDP Firewall`


### 正式探测

客户端向服务器请求 NAT 类型探测（`STUN:Cone`）服务。

服务器仅需执行两个操作：

1. `NewPort`: 用一个新的端口（随机）回复消息。
2. `NewHost`: 请求另一个服务节点（新IP）辅助，向客户端地址发送消息。


#### 1. 客户端

本地创建一个 QUIC 服务监听。

通过该监听端口向服务器拨号（创建NAT映射），发送 `STUN:Cone` 请求。数据包含：

1. SN：会话标识。
2. SPKI：本地监听证书公钥编码哈希。
3. 排除清单：预探测期间曾经连接过的目标地址。

> **注：**
> `NewHost` 协助需要一个未与客户端关联过的新IP，因此提供排除清单。


#### 2. 服务器

获取客户端公网映射地址，以及发来的数据。执行如下操作：

- `NewPort`: 用一个新的随机端口拨号到客户端。证书验证用SPKI，发送数据为SN。
- `NewHost`: 请求一个不在排除清单中的组网节点向客户端发送消息。传递相关数据：
    - 客户端公网映射地址。
    - 客户端提供的 SN 和 SPKI。

协助执行 `NewHost` 的组网节点用一个任意端口拨号到客户端即可，SPKI验证证书并发送SN。

> **注：**
> `NewPort` 和 `NewHost` 发送的 SN 会被前置一个标识以便区分。


#### 3. 客户端

监听2个服务端的拨号连入，以及必要的 SN 核验和区分。

> **注记：**
> 可能通过管道方式（=> Channel）通知&判断。


#### 类型判断

客户端根据 `NewPort` 和 `NewHost` 两个连入的情况，综合判断自身 NAT 类型或所在网域。

**NewPort**:
- 收到 => `RC | FullC`。注：`FullC` 在*NewHost*段确认&覆盖。
- 超时 => `P-RC | Sym` => `P-RC`。注：`Sym` 已在预探测中确认并排除。

**NewHost**:
- 收到 + 预探测.N => `FullC`。
- 收到 + 预探测.Y => `Open Internet`，即 `Pub`。
- 超时 + 预探测.Y => `UDP Firewall` 网域。


### 图示

```
                            +--------+           NewHost Request
                            | Serv.1 | ------------------------+
                            +--------+                         |
                              |    |                           |
                              |    |                           V
+--------+                    |    |                      +--------+
| Serv.0 |                    |    |                      | Serv.2 |
+--------+                    |    |                      +--------+
    |                         |    | 2)                        |
    |                      1) |    | NewPort                   | 2)
    | 1)               Addr.1 |    |                           | NewHost
    | Addr.0                  |    |                           |
    V                         V    V                           V
+-------------------------------------------------------------------+
|             LocalAddr             Received?           Received?   |
|  [Client]                                                         |
+-------------------------------------------------------------------+


1)
Addr.0 != Addr.1   ---> Sym. END.
Addr.0 == Addr.1/
    Addr.1 == LocalAddr (Y)   ---> Open Internet | UDP Firewall
    Addr.1 != LocalAddr (N)   ---> (Next Step...)

2)
NewPort: Received/
    Yes   ---> RC | FullC
    No    ---> P-RC
NewHost: Received/
    Yes & 1.N   ---> FullC
    Yes & 1.Y   ---> Open Interent (Pub)
    No & 1.Y    ---> UDP Firewall
```


### 消息频率

服务端发送UDP探测包的频率遵循 RFC3489 协议，初始间隔从 100ms开始，逐次加倍直到收到回复或超时。

到达 1600ms 后就不再加倍间隔时间，最多发送 9 次。

间隔时间（ms）：100, 200, 400, 800, 1600, 1600, 1600, 1600, 1600 结束。
累计时长（ms）：100, 300, 700, 1500, 3100, 4700, 6300, 7900, 9500 超时。


### 附：NAT类型发现流程参考（RFC3489）

```
                        +--------+
                        |  Test  |
                        |   I    |
                        +--------+
                             |
                             |
                             V
                            /\              /\
                         N /  \ Y          /  \ Y             +--------+
          UDP     <-------/Resp\--------->/ IP \------------->|  Test  |
          Blocked         \ ?  /          \Same/              |   II   |
                           \  /            \? /               +--------+
                            \/              \/                    |
                                             | N                  |
                                             |                    V
                                             V                    /\
                                         +--------+  Sym.      N /  \
                                         |  Test  |  UDP    <---/Resp\
                                         |   II   |  Firewall   \ ?  /
                                         +--------+              \  /
                                             |                    \/
                                             V                     |Y
                  /\                         /\                    |
   Symmetric  N  /  \       +--------+   N  /  \                   V
      NAT  <--- / IP \<-----|  Test  |<--- /Resp\               Open
                \Same/      |   I    |     \ ?  /               Internet
                 \? /       +--------+      \  /
                  \/                         \/
                  |                           |Y
                  |                           |
                  |                           V
                  |                           Full
                  |                           Cone
                  V              /\
              +--------+        /  \ Y
              |  Test  |------>/Resp\---->Restricted
              |   III  |       \ ?  /
              +--------+        \  /
                                 \/
                                  |N
                                  |       Port
                                  +------>Restricted
```

文档：https://datatracker.ietf.org/doc/html/rfc3489#section-10.2



## 存活期探测（`STUN:Live`）

NAT映射有存活期，节点静默超时后NAT会关闭其映射。

对某些应用来说，存活期探测可能是必要的，因此本设计也提供此服务。


### 前提条件

消息通讯采用 QUIC 安全连接 + 普通 UDP 链路混合模式。

- 服务端不会主动发起 Keep-Alive 的 PING 心跳包。
- QUIC 服务端的 Idle-Timeout 为固定的**2**分钟。因此映射存活期的最大可探测时间小于2分钟。


### 1. 客户端

创建一个本地普通UDP监听。

从监听端口向一个服务节点拨号（QUIC），创建NAT映射，请求映射到公网的地址（IP:Port）。

获取到自身的公网映射地址后，关闭 quic.Conn。即：从 QUIC 退化到普通 UDP 链路。

> **注：**
> 获取到的端口号备用（`Port.0`）。
> 关闭上层 quic.Conn 并不会影响底层 net.UDPConn。


#### 服务器响应

- 发送客户端公网映射地址。
- 关闭与客户端的 quic.Conn 连接，配合客户端链路退化（到 UDP）。

> **注：**
> 关闭特定 quic.Conn 也不影响上层 QUIC 监听。


### 2. 客户端

用一个新的随机端口向同一服务节点拨号，创建 QUIC 连接。

向服务器请求存活期探测（`STUN:Live`）。发送数据：计数（Cnt）、SN、端口（`Port.0`）。


#### 服务器响应

- 提取客户端的来源IP，以及发送的端口号，组合客户端原公网映射地址。
- 向客户端地址拨号（普通UDP），发送消息：`Cnt+SN`（明码）。

服务器每收到一个 `STUN:Live` 请求，即发送一个回应。


### 循环：客户端 <=> 服务器

客户端会多次向服务器请求 `STUN:Live` 探测。

时间间隔：

- **粗测**：起始间隔从20秒开始，15秒增量（精度）。即如：20s, 35s, 50s ...
- **精测**：粗测中超时失败后得到有效间隔，开启精测，精度设为3秒。

> **注：**
> 共需两次完整的测试循环，但精度足够细。


#### 旧链路配合

因为有的NAT映射只认外出消息，所以初始创建并退化的旧链路需要维持活性。

当客户端向服务器请求一次 `STUN:Live` 时，先在旧链路上发送一个 PING 包（服务端会回应一个 PONG 响应）。这样就可以维持 NAT 的新鲜，同时也是 NAT 映射和下一次请求的计时重置（新零点）。


### 判断

- 如果在先前的端口（`Port.0`）上收到回应，表示映射没有改变。
- 如果没有收到回应，表示映射已经改变，回应不可达。

最终，客户端可能需要向不止一个公共服务器请求测试，综合评估结果。
