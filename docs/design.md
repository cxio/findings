# Findings设计

## 基础服务

相互连接组网的Findings节点可以构成一个服务网络，它们提供P2P网络需要的基础服务。

节点连接服务器，服务器即可告知节点所在网域的NAT映射网址（公网）。在此基础上，提供如下服务。

- **UDP**: 简单提供Findings公网节点信息分享。
- **UDP**: 协助探测节点所在网域的NAT类型（`FullC|RC|P-RC|Sym`）和NAT映射存活期。
- **UDP**: 提供连接服务器的多个节点间的UDP打洞协助（信令中介）。
- **UDP**: 为打洞连接的节点持续提供信令协调（节点地址变化后的再沟通）。

- **TCP**: 接受应用节点登记自己为TCP公共服务器（注册）。
- **TCP**: 向应用节点提供相应类型的TCP公共服务器（分享）。
- **TCP**: 简单提供Findings公网节点信息（由客户端主动抓取）。
- **TCP**: 简单提供自身的UDP监听地址（公网），协助节点确认自身UDP被封。


### TCP 弱支持

Findings网络节点之间主要运行 QUIC（UDP）协议。

但有些网域可能封禁 UDP 消息，所以组网节点（`Pub/FullC`）支持通过 Websocket 连入：

- **应用**：支持 TCP 服务节点*登记*，以及对登记信息的*获取*。
- **本网**：可直接*获取*Findings公网节点的信息。主要用于应用本地私开的Findings服务器。

这里的TCP仅为弱支持，并不是**分享**的逻辑，只有获取（GET）操作，无主动发送。

> **注：**
> 对于应用本地私开的Findings服务器，可以仅用TCP，而不论自己是否被UDP封禁。
> 应可配置：启用TCP抓取（在连出或连入完成时自动执行）。抓取的信息会合并到候选池。

这可以一定程度缓解 UDP 封锁对Findings网络的影响。

<!--
注记：
因为禁用 UDP 的网域无法（也无需）NAT 相关服务，
所以取消了原用 Websocket/TCP 链路支持 NAT 探测的设计，改用更简单高效的 QUIC。
-->


### 数据协议

节点之间的通讯采用 protoBuf 数据编码方式。



## 功能结构

### 组网

相互连接、分享信息，构建持续运行的Findings网络。

因为P2P节点之间无需信任，所以采用自签名证书创建安全连接（**注**：由地址对应的 SPKI 验证公钥的匹配性）。

网络主要采用基于 UDP 的 QUIC（Quick UDP Internet Connections） 协议，因此只有支持 UDP 的网域节点才能参与组网。

组网节点的行为：

1. 分享彼此缓存的其它组网节点信息，实现资源的全网流通和随机分布。
2. 提供NAT相关服务：NAT类型和映射生命期探测。

> **注：**
> NAT `Pub/FullC` 类型才能提供服务，因为它们可直接连入。
> NAT 受限节点不能提供服务，但可以参与分享信息，同时也可以协助NAT探测中的 `NewHost` 操作。


### 应用

Findings节点除了组网之外，还提供对应用的服务。

应用节点连接Findings网络的组网节点，可以申请NAT探测或UDP*打洞协助*，以及持续的打洞*信令协调*服务。

对于 UDP 被禁用的网域，应用可以通过 Websocket 连接组网节点，查询应用关联的 TCP 服务器节点（如果有）。

> **注：**
> Findings节点也可以以应用类连入Findings网络，申请NAT相关服务。


### 附：节点信息

如下几个字段概括了节点的必要信息：

- 类型：depots:xx | blockchain:xx | app:xx | findings:xx
- 网络：TCP 或 UDP（"udp"|"tcp"）
- 地址：IP:Port（公网可见）
- SPKI：证书的公钥编码哈希。**注**：自签名证书会在App启动后自动创建。
- NATT：NAT-Type（Pub/FullC | RC | P-RC | Sym）

> **注：**
> 同一份自签名证书可同时用于 QUIC 和 Websocket 的安全连接。



## 实现细节

Findings节点内部维持几个节点池，用于实现不同的功能区分。


### 候选池

暂存可直接连入的 `Pub/FullC` 类公网节点，当执行连接切换时，从中随机抽取节点。

当新的连接创建后，双方会彼此分享自己候选池中的一部分节点信息。分享的节点在合并前会做必要的测试（可连接性、证书SPKI是否匹配等）。

候选池是Findings服务节点的汇聚地，大小限额可由用户配置（通常 >100）。

> **注：**
> 从 TCP 链路上请求的Findings服务节点也从此提取。


### 组网池

即当前组网节点的连接池，维持Findings网络的运行。

服务器需要维护组网池中的节点的连接，定时分享候选池信息。除此之外，它还提供任意节点对其自身NAT类型，以及NAT映射存活期探测的服务。

NAT类型探测和映射存活期探测不需要知道节点的应用类型。

组网池大小可能为**16**（8+8），不可配置。

> **注：**
> 在NAT类型探测中，NewHost请求需要组网池中另一个节点配合，所以该服务集成在这里。


### 应用池

暂存各类应用节点的连接，提供同类或异类节点间的UDP*打洞协助*（信令中介）、*信令协调*。

异类应用节点间的连接是可能的，比如两种需要相互协作的应用类型（例：组队校验中的校验员和守卫者）。

> **注：**
> 作为应用的Findings节点连入时也存在此池中。

打洞协助所支持的应用类型由Findings节点（用户）自己选择和配置。

应用池大小限制可能为 **500**（可配置）。


### 分享池

暂存支持TCP直连的服务器节点，按应用分类。这使得应用节点在必须使用TCP时，可以很方便地连接到所需的服务器。


### 常驻服务

各个功能池应当包含各自的常驻检查服务，侦测节点连接的有效性，及时更新（清除无效连接）。


### 经济激励

当Findings服务节点接受应用节点的连入时，会主动提供一个区块链地址，用于接收可能有的奖励。

如果应用节点是区块链类型，发送的应当就是该区块链应用的地址，否则就应当是一个通用的区块链（如比特币或以太坊）地址。

这是Findings网络持续运行的经济基础。

> **注：**
> 提供NAT相关探测服务时，服务器也需要知道对端是否为区块链类型，以及属于哪个区块链。



## 打洞协助

打洞协助由应用池负责。

应用池中保留了各应用节点的连接信息。根据请求，服务器为它们互传必要的信息（中介信令），从而协调其打洞互连。


### 已知前提

双方已经获知对方的NAT映射地址（外部地址和端口）。


### 特例：`Sym --> Pub/FullC`

对称型节点端口不确定，无法参与打洞协作，因此只能向外与 `Pub/Fullc` 建立连接（单向）。


### 基本规则

遵循两端同时监听和拨号（Listen + Dial）同时打洞的规则，以有效应对“半开口子”的 NAT。

双方的最终主从关系由节点动态生成的序列号判断：大者监听（Listen），小者拨号（Dial）。如果两个序列号相同（概率极低），则用双方的IP地址对比，规则相同。


### 消息包

打洞双方沟通的消息，包含了相互指向的地址，以及识别标识。

```go
Message {
	IP      bytes  	// 对端公网IP
	Port    int  	// 对端公网端口
	Token   bytes  	// 会话标识（也用于主从判断）
}
```


### 定向打洞

请求服务器对指定的地址协助打洞。

这需要目标地址对应的节点已经与服务器建立了连接（在应用池内）。

一个典型的用例：数据网络（depots）上请求源节点与数据源节点之间的UDP连接，如果双方都是受限节点，这是必须的。

> **注：**
> 数据网络会将数据源节点的UDP地址及其所连接的Findings节点等相关信息回传到请求者。


### 信令协调

提供了打洞协助的服务节点，应当保留对所协助节点的连接，以持续提供“信令协调”的服务。

即：通过打洞连接的两个节点，如果其中一个被改变了外网NAT映射，服务器应当协助两个节点重新建立连接，以维持其正常通讯。



## 网络的连通性

传统的P2P网络有一个中心化问题：初始上线节点需要从一个已知的中心化节点获知其它在线节点的信息。

这个中心化节点通常是一个服务器，硬编码在App配置中。这会导致一种风险：App中配置的节点可能被封禁。于是……对于被封禁网域的人来说，P2P并没有优势。

虽然也有其它一些方法来获取初始的连接信息，但实际上，如果网域的管理者很认真的话，它们一样可以被封堵。


### 暴力发现

Findings是一个P2P网络，组成网络的节点可能规模庞大……如果不考虑及时性，一种遍历全网IP的**暴力发现**模式可能是行得通的——因为目标巨大。

用户可以用一台小设备挂机……一旦成功探查到某个服务节点，就破解了封锁。

作为一种优化，历史IP可能是有用的，服务节点可能只是切换到了它附近的位置，因此以历史IP为原点的遍历可能更有效。


### 标准端口混入

如果Findings的默认端口被屏蔽，可以针对通用服务端口进行混入，比如 https 的 443（仅适用 Websocket/TCP）。

探测请求有自己的格式/约定，因此真正的服务会忽略它们，无害。


### 动态端口（含工作量）

另一种避免端口封锁的方法是**动态端口**策略。如果动态端口隐含了工作量，被侦测屏蔽的风险会更小。

虽然端口是动态的，但它也应当是可预测的，不过用户需要先执行一定量的计算量才能获知目标端口。

> **算法参考：**
> 加入服务器的IP地址为动态因素，使每一个探测都个性不同。
> 目标端口在一定的时间段（如1小时）内维持不变，以获得确定性。


#### 动态端口算法

加入了工作量机制，伪代码示意如下：

```go
// App配置项：
// 在App发布时配置，连接各方此值相同。
var timeFrom   time.Time = GetConfig("timeFrom")    // 起始时间
var randBase    int64    = GetConfig("randBase")    // 随机种子
var diffValue  [32]byte  = GetConfig("diffValue")   // 难度目标（前置零越多越难）

// 参与计算的因子（动态）
var IP netip.AddrPort   // 服务器地址
var hours int64         // 起始时间到当前时间的距离
var portRnd int64       // 端口随机数

// 确定性随机
rand.Seed( randBase )

// 随机值上界
const randMax = 1<<63 - 1

// 工作量循环
for {
    // 单小时确定
    hours = time.Since(timeFrom) % time.Hour
    portRnd = rand.Intn(randMax)

    // 串联计算哈希
    tmp := sha256.Sum256( IP + hours + portRnd )

    if tmp < diffValue {
        break // 满足目标难度
    }
}
// 最终端口
return (portRnd % 64511) + 1024
```

备用端口：目标端口 `+1` 和 `+2`。例：计算端口 `6688`，则备用端口为 `6689` 和 `6690`。避免目标端口被系统占用的情况。


### 服务器群

服务节点会向应用提供自己的区块链地址，用于接收可能有的收益分成或捐赠。

在区块链对公共服务的激励机制中，服务节点需要对区块链铸造者可见且被认可才行。所以一个足够规模（可见性高）且服务良好的服务器群是有意义的。

这里的服务器群是抽象的：*只要服务节点提供同一个收益地址，它们就是一个群*。无需真正的物理连接。

这是一种离散、自由的组织机制。当然，一个真实物理连接的集群也适用于此。


#### 群成员辩识

为便于区分服务器群里的成员，以方便管理者对其考评和奖励，设计增加了一个**身份ID**的逻辑：标识具体的服务节点。

身份ID通常就是服务节点自己的一个区块链账户地址，在与区块链应用节点连接时，身份ID会与群收益地址一起发送。
