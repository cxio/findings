# findings 详细设计

## 共用规则

### 节点信息

节点是一台正常连接公网的客户机，它需要包含如下信息以表达一个完整的节点逻辑。

1. 公网IP地址。
2. 服务端口。可能是固定的，也可能是双方根据一定规则计算的，NAT网关内节点则是由NAT动态分配的。
3. NAT类型。共分为6种：`Pub0` `Pub1` `FullC` `RC` `P-RC` `Sym`（详见 stunx.md），其中前两种属公共域，不受NAT约束。
4. 临时公钥。用于初始连接请求的加密，通常为即时生成（端口对应）。

> **注：**<br>
> Findings网络的节点初始连接没有对方的公钥，因此采用DCP协议中的无公钥方案。<br>
> 其它所有非Findings节点在Findings网络中登记并提供公钥，因此可以更为简单和安全。<br>

为防止攻击，Findings节点不提供指定NAT类型的集合请求，而是根据对端的NAT类型提供随机但合理的节点集。如对端为 `Symmetric NAT` 类型，就不会提供 `RC/Restricted Cone` 以下类型的节点信息。


### 连接原则

Findings服务器会缓存一定数量的同类节点和登记注册的应用节点，各个Findings服务器的缓存并不相同，虽然会有部分重叠。一台Findings服务器不必也不应当存储全网的节点信息。

应用节点可以从Findings服务器中获取数量不少的同类节点信息，大部分都应该有效。节点可以尝试与它们中的一部分连接，遵循如下基本原则。

1. **随机性**：随机地抽取节点集中的成员，尝试连接测试。
2. **资源利用率**：按NAT类型中的可连入性，尽量与低可连入性的节点建立连接，最大化节点资源的使用。
3. **效率适中**：不一定选择网络延迟最低的目标，因为那些目标很可能物理上太近，从而使得你自身受到物理上的局限。

> **注：**<br>
> 这里的应用节点泛指除了Findings节点之外的其它所有节点，它们依托于Findings网络，包含应用层的App和其它公共服务的节点。


## 组网

### 初始连接

**端口：**

- 标准端口号：7788 (TCP/UDP)
- 动态端口号：目标难度工作量的初次匹配（确定性递增），见README算法说明。

**IP：**

- App内置预定义。
- 历史IP记录（peers.dat）或预配置延伸起点，原点延伸随机算法。

**NAT探测：**

获得Findings节点回应后探测自身NAT类型。

**加入网络：**

请求Findings网络节点信息集，建立更多Findings连接。连接兼顾各个NAT层次的节点，充分利用在线节点资源。

组网完成。


### 连接策略

1. 公共开放节点：Pub0, Pub1, FullC，端口不限。
2. NAT穿透节点：RC 类型节点，端口不确定。
3. NAT半穿透节点：P-RC 类型节点，端口不确定。
4. 无穿透单向节点：Sym 类型节点，端口任意。

以上4类节点开放性逐渐降低，连接策略为：

1. 高开放性节点连接为基础保障，一定数量必要保持。
2. 尽量与低开放性节点建立连接，接收Sym节点的连入并适度保持，可分派NAT探测协助任务。

> **注：**<br>
> 高开放性节点会承担一定程度的TURN数据代理负载（视网络连接的困难程度而定）。



## 配置

### 收益地址


### 服务目标



## 服务



------------------------------------------------------------------------------

## 开放注记

- 节点信息有本地暂存，不应长期存储。
- 节点可接受权益地址的签名控制指令，比如：载入新配置、重启、软件升级等。
