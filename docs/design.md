# Findings设计

Findings是一个基础公共服务网络，提供各种P2P应用的同类节点发现和连接辅助（如NAT打洞中介）。

Findings网络本身是P2P的，它由区块链应用的奖励提供运行的经济支持。虽然理论上也可接收非区块链应用的捐助，但实际效果应该不大。

区块链应用是P2P的，节点发现是一个不可或缺的基础需求。避免起始节点中心化的脆弱性，一个遍布互联网的节点发现公共服务是有价值的。而区块链的数字化直接支付能力，为这一机制提供了存在的前提。


## 组网规则

不同的Findings节点相互连接组成一个P2P网络，动态更新连接、切换，彼此交换必要的信息，运行为一个强壮的P2P服务网络。

每个节点在完成Findings组网的同时，支持其它应用类型的节点的连接，提供 NAT 类型探测和打洞协助（信令服务器的角色）。对于区块链类应用节点，服务器应当提供相同区块链类型的账户地址，接收可能有的区块链奖励（gratuity）。对于非区块链类应用，虽然理论上也可以提供某个流行区块链的账户地址来接收捐赠，但这不太可能成为主流。

服务器支持哪一类应用以及能提供什么账户地址，是在Findings节点上个性化配置的，它由节点自己做主。


### Findings节点组网

可接受直接连接的Findings节点需直接或间接位于公网之上（`Pub/FullC`），它们是Findings网络主要交换的数据之一，这里简称为Findings的公网节点。公网节点之间的连接称为Findings组网。

通常情况下，一个应用可以长时间运行一个Findings客户端（挂机），获取到Findings网络的部分公网节点，然后找到支持本类型应用的服务器，并请求服务。**注**：Findings客户端本身拥有强力发现能力。

Findings组网不支持位于NAT之后的不能直连的节点（`RC/P-RC/Sym`），这些位于NAT之后的节点只能以*findings类型*应用连接主网，获得主网提供的打洞服务来与其它节点互连。

> **注：**
> 公网节点依然可以从连入的NAT受限节点获取其它公网节点的信息，这在受限节点入网正常后发生。这可以帮助强化Findings网络的健壮性。


#### 公网节点信息

可直接连入的公网节点（`Pub/FullC`）相互之间通过TCP连接组网，彼此仅仅需要知道对方的IP地址和端口即可。

连接通常采用支持安全协议（`TLS/SSL`）的链路，虽然本网的P2P节点间并不需要相信对方（知道对方的证书），但安全协议本身可以避免外部第三方窥探和信息泄露，以及可能的信息分析及阻断。


#### 应用节点信息

应用节点连接Findings主网来获取 NAT 探测和 UDP 打洞协助服务。当前的主网暂不支持 TCP 的 TURN 中继服务。

应用节点需要提供如下的信息。

- 应用类型：depots:xx | blockchain:xx | app:xx | findings
- 连接协议：tcp | udp
- NAT 类型：Pub | FullC | RC | P-RC | Sym
- 公网地址：IP:Port
- 加密公钥：算法&公钥

应用提供的协议类型（tcp|udp）可方便其它节点决定自己的连接策略。通常，只有可直连（Pub/FullC）的节点才需要支持TCP，因为这里不提供TCP的TURN中继服务。


#### 候选池

候选池暂存一些公网节点，它们都是可直接连通的。当节点进行连接切换的时候，会从候选池中随机抽取进行连接。

连接切换通常10分钟一次，一次切换1~2个节点。当与新的节点连接后，会获得对端的公网节点数据分享（对端候选池内信息）。新获得的节点信息会与当前节点的候选池混合：测试可连接性，排除无效和重复。然后从中优选以维持候选池原有规模。

挑选原则：*低延迟优先，适当兼顾中高延迟节点，避免地域明显分割*。

> **注记：**
> 候选池的大小限制是柔性的，会有一个专门的进程负责清理和池大小管理。


#### 组网池

即公网节点的当前连接池，仅支持 TCP 协议。组网池成员通常是公网节点，但通过TCP主动连入的受限节点并不能被识别，不过这并不构成问题。组网池是实时连接的节点集，承担STUN相关服务。虽然受限节点不能直接接受其它节点的接入（从而提供服务），但它们可以配合主服务器提供如 `NewHost` 的辅助性服务。

当节点检查到有连接丢失/无效后，即主动外连或接受外部传入的TCP连接并入池。**参考**：连接池大小可能为 `12`，用户可配置。


#### 受限连接池

适用于NAT受限类型节点，它们与主网的公网节点通过TCP建立连接，或与其它受限节点通过UDP打洞建立连接。因此同时支持 TCP 和 UDP 两种链路。

受限连接池存在于受限节点或伪装为受限节点的公网节点上。当节点检查到有连接丢失/无效后，即主动外连主网或请求打洞连接其它NAT受限节点。TCP/UDP 两者链路的连接数量通常各占一半。

> **注：**
> 受限节点对主网公网节点的主动连接是临时的，仅用于交换节点信息，因此并不占用组网池大小额度。
> 但这种区分只是根据请求的服务指令来判断，并不准确。一个公网节点也可以发送同样的指令（即请求同样的服务）。


### 对应用的支持

每个Findings节点能提供的服务可能不同，这由节点自身的配置决定。如果一个应用节点请求一个Findings节点的服务未能得到满足，它可以尝试其它Findings节点。

这也是应用端通常需要自己运行一个Findings服务器的原因：这个局部的Findings服务器连接到Findings主网，从而获取到其它Findings服务节点。这个局部的服务器通常不参与Findings组网，而是仅仅请求其它服务节点信息，也即上面所指的受限节点。

> **注：**
> 能提供打洞服务的Findings节点只能是公网节点，因为只有它们能直接接收其它应用节点的连接。


#### 应用连接池

Findings服务器支持的每一个应用都对应于一个该应用类型的连接池，所有的应用连接池共同形成为一个连接池组。

应用连接池的大小依然是有限制的，但容许的额度会比较大。连接池成员是动态更新的，如果池已满，则新加入成员时会触发池状态更新：移除一部分较旧的成员来获得空间。

考虑效率，移除旧成员的算法可能很简单但不够精确，这在随机获取节点信息的逻辑下，问题不大。



------------------------------------------------------------------------------

## 注意事项

- 节点信息有本地暂存，但不应长期存储。
