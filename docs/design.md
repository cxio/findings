# findings 详细设计

## 共用规则

### 节点信息

节点是一台正常连接公网的客户机，它需要包含如下信息以表达一个完整的节点逻辑。

1. 公网IP地址。
2. 公网端口号。固定，或者根据一定规则计算出来的。内网节点则是由NAT网关动态分配的。
3. NAT类型。分为6种：`Pub0` `Pub1` `FullC` `RC` `P-RC` `Sym`（见 stunx.md）。其中前两种属公共域，不受NAT约束。
4. 临时公钥。用于初始连接请求的加密。


#### 安全性

为防止攻击，Findings节点不提供指定NAT类型的集合请求，而是根据对端的NAT类型提供随机但合理的节点集。如对端为 `Symmetric NAT` 类型，就不会提供 `RC/Restricted Cone` 以下类型的节点信息。


### 连接原则

Findings服务器会缓存一定数量的同类节点和登记注册的应用节点，各个Findings服务器的缓存无需一致。考虑安全性，一台Findings服务器也不应当存储太多节点的信息。

应用节点可以从Findings服务器中获取一定数量的同类节点信息，连接遵循如下基本原则。

1. **资源效率**：按NAT类型中的可连入性，尽量与低可连入性的节点建立连接，最大化节点资源的使用。
2. **效率适中**：不一定选择网络延迟最低的目标，因为那些目标可能物理上太近，因而受到某种社会性局限。

> **注：**
> 这里的应用节点泛指除了Findings节点之外的其它所有节点，包含应用层App和其它公共服务节点。


## 组网

### 初始连接

**端口：**

- 标准端口号：7788 (TCP/UDP)
- 动态端口号：目标难度工作量的初次匹配（确定性递增），见README算法说明。

**IP：**

- App内置预定义。
- 历史IP记录（peers.dat）或预配置延伸起点，原点延伸随机算法。

**NAT探测：**

获得Findings节点回应后探测自身NAT类型。

**加入网络：**

请求Findings网络节点信息集，建立更多Findings连接。连接兼顾各个NAT层次的节点，充分利用在线节点资源。

组网完成。


### 连接策略

1. 公共开放节点：Pub0, Pub1, FullC，端口不限。
2. NAT穿透节点：RC 类型节点，端口不确定。
3. NAT半穿透节点：P-RC 类型节点，端口不确定。
4. 无穿透单向节点：Sym 类型节点，端口任意。

以上4类节点开放性逐渐降低，连接策略为：

1. 高开放性节点连接为基础保障，一定数量必要保持。
2. 尽量与低开放性节点建立连接，接收Sym节点的连入并适度保持，可分派NAT探测协助任务。

> **注：**
> 高开放性节点会承担一定程度的TURN数据代理负载。



## 配置

### 收益地址


### 服务目标



## 服务



------------------------------------------------------------------------------

## 开发笔记

- 节点信息有本地暂存，但不应长期存储。

