# Findings设计

Findings是一个基础公共服务网络，提供各种P2P应用的同类节点发现和连接辅助（NAT层级探测和打洞协助）。

Findings网络本身是P2P的，它由区块链应用的奖励提供运行的经济支撑。虽然理论上也可以接收非区块链应用的捐助，但实际效果可能不佳。

区块链应用是P2P的，节点发现是一个基础性需求。为避免初始节点中心化的脆弱性，一个遍布互联网的节点发现公共服务是有意义的。而区块链加密币的直接支付能力，为这一机制提供了驱动力。


## 组网规则

不同的Findings节点相互连接组成一个P2P网络，动态更新连接、切换，彼此交换必要的信息，运行为一个强壮的P2P公共服务网络。

每个节点在完成Findings组网的同时，也支持其它应用类型的节点连接，提供**NAT类型探测**的基础服务和**打洞协助**的信令服务。

对于区块链类应用，服务器应当提供相应区块链类型的账户地址，来接收可能有的区块链奖励（gratuity）。对于非区块链类应用，服务器也可以提供一个流行区块链的账户地址来接收可能有的利益回馈。

服务器支持哪一类应用以及提供什么区块链的账户地址，是由Findings节点自己个性化配置的，节点自己做主。


### 公网节点

可被直接连入的 `Pub/FullC` 类型节点，在这里我们称为公网节点。

在Findings网络中，公网节点之间通过TCP连接组网，连接采用安全协议（`TLS/SSL`）链路。P2P节点之间并不需要信任，无需验证对方的身份，采用安全协议是为了避免外部第三方窥探和分析，以及可能有威胁的中间人定向攻击（针对特定客户端攻击）。


### 应用节点

应用节点是除了Findings组网节点之外的所有类型的节点。它们连接Findings网络，获取NAT探测服务以及UDP打洞协助。

> **注：**
> 当前的Findings网络不提供TCP链路的TURN中继服务。

应用节点通常包含如下信息：

- 应用类型：depots:xx | blockchain:xx | app:xx | findings:xx
- 公网地址：IP:Port
- NAT 层级：Pub/FullC | RC | P-RC | Sym
- 密钥公钥：密钥交换算法的公钥，用于初始连接时传递自签名证书，以创建安全连接

其中公网地址（IP:Port）在节点连接Findings网络后即可获知，如果节点不处于公网，可以请求NAT层级探测服务。如果节点还需要UDP打洞协助，则NAT层级探测是必需的。

本系统不支持TCP的TURN中继服务，作为一种折衷，这里支持TCP公网服务器的登记。这样，在TCP链路上，应用客户端就可以直接获取其服务器节点，这也是一种良好的便捷。

> **注：**
> 普通的Findings节点也可以作为应用节点申请NAT探测和打洞服务，如果它不是声明“组网”的话。


### 节点组网

Findings类节点相互连接、协作，动态地交换信息，维持Findings网络持续运行……就是Findings组网。

直接接受连入的Findings节点需位于公网之上（`Pub/FullC`），而如果只是连出，则没有这个限制（就像一个普通的Findings客户端一样）。通常情况下，一个应用可长时间运行一个本地的Findings客户端（挂机），让它连接到Findings网络，交换获取其它公网节点信息，然后寻找支持本类型应用的其它Findings服务器。

> **注：**
> 公网节点依然可以从连入的NAT受限节点获取其它公网节点的信息，这可以强化Findings网络的健壮性。


#### 候选池

候选池暂存一些Findings公网节点，当节点进行连接切换的时候，会从候选池中随机抽取进行连接。

连接切换通常几分钟一次，一次切换1~2个节点。当与新的节点连接后，会获得对端的候选池节点数据分享。新获得的节点会与当前节点的候选池混合：在可连接性测试和去重后，并入当前候选池。

> **参考：**
> 挑选原则：*低延迟优先，适当兼顾中高延迟节点，避免地域明显分割*。


#### 组网池

即维持Findings网络组网功能的节点连接池，仅支持 TCP 协议。组网池成员通常是公网节点，但通过TCP主动连入的受限节点并不能被识别，不过这不是问题。

组网池成员负责Findings网络的维系：动态更新连接、交换公网节点信息，以及 NAT 探测中的 `NewHost` 辅助服务。

> **注：**
> NAT受限节点虽然不能直接接受其它节点的连入以提供服务，但配合 `NewHost` 则没问题。


#### 应用池

接受其它各类应用节点的连入，提供NAT探测服务和其应用自身的 `UDP:STUN` 打洞协助服务。

位于NAT之后的Findings节点也可以以*findings类型*应用来连入公网节点，获得与其它同样位于NAT之后的Findings节点间的打洞服务。打洞连接仅能支持 UDP 协议。

> **注：**
> 能提供打洞服务的Findings节点只能是公网节点，因为只有它们能直接接收其它应用节点的连接。


#### 对应用的支持

每个Findings公网节点都能提供NAT探测服务，但打洞服务所支持的应用类型则可能不同，这由节点自身的配置决定。


#### 分享池

接受支持 TCP 可直连的应用服务器节点的登记，方便其同类应用节点找到它而实现该应用的P2P连接组网。


### 连接安全

节点间的连接采用带TLS的安全websocket连接（`wss://`），保证数据通讯的私密性，避免外部对明文的监听。

因为TLS协议需要证书，但P2P网络节点基本上无需关心对方是否可信，因此这里采用一次性**自签名**证书，并设计了一个特别的初始连接流程。

> **注：**
> 这里的一次性表示服务器启动之后，自动生成的自签名证书，仅限于当前运行期间使用。
> 此证书存在于内存中，如果服务器重启或关闭，证书和私钥即丢失，没有节点能再连接使用此证书的节点。


#### 组网节点之间

拥有公网地址的组网节点都有一个自己的ECDH公钥，组网之后，节点的公钥和地址（IP:Port），会通过与之组网的节点广播到Findings网络中。

一个新上线的组网节点（客户端）连接Findings网络，在得到其它组网节点（服务器）地址的同时，也会得到服务器自己的ECDH公钥。

如果客户端获得了其它组网节点的信息（地址和公钥），之后的连接遵循如下流程：

0. 客户端已启动一个含自签名证书的服务监听，常驻运行。
1. 客户端连接服务端，忽略服务端的自签名证书验证。建立初次连接（不可靠）。
2. 客户端用自己的ECDH私钥和服务器端的ECDH公钥计算共享密钥，加密自己的自签名证书以及服务端口（会使用到一个随机数Nonce）。
3. 客户端将密文和自己的ECDH公钥明文（以及解密需要的Nonce）发送给服务器。
4. 服务器获取客户端ECDH公钥，计算共享密钥，结合Nonce解密自签名证书和服务端口。
5. 服务器变身为客户端，设置信任该自签名证书，向对端（原客户端）发起连接。
6. 原客户端此时也为服务器，接受连接。至此即完成正常的安全连接。

> **注：**
> 新上线客户端的首次连接仅仅会发送一个上线协助请求，简单获取其它组网节点的信息，没有更多交互。
> 上线协助也可以同时向多个目标发送，以避免单点风险（比如刚好对端是一个恶意节点）。

这里设计了角色切换，这样可以限制双方都必须是公网节点（至少可直连）才行。这正好实现了对*组网节点必须是公网节点*的约束。

> #### 附：ECDH公钥开放存储的安全性
>
> 服务器的ECDH公钥由Findings网络携带并提供而不是在初次连接时由服务器即时提供，会更安全一些。
> 因为攻击者篡改公网存储的ECDH公钥是通过自身成为组网节点来实现，但从它这里获取服务器节点信息的应用端却是不确定的。
> 也即：攻击者很难通过这种方式定向攻击某个客户端。
>
> 而如果是让服务器实时提供自身ECDH公钥，那中间人攻击者就可以锁定客户端，因为此时的ECDH公钥就在当前链路上。


#### 从应用端的连接

应用端（NAT内网）节点对公网节点的连接没有角色切换（也无法切换），采用如下流程：

1. 客户端连接服务器，忽略服务器端自签名证书的验证。建立首次连接（不可靠）。
2. 客户端用服务器的ECDH公钥和自己的ECDH私钥创建共享密钥，加密一个标识ID（标识当次会话）。**注**：加密需要一个Nonce值。
3. 客户端打包这个标识ID密文、自己的ECDH公钥明文，以及解密需要的Nonce值，传递给服务器。
4. 服务器用客户端的公钥和自己的私钥创建共享密钥，结合Nonce值解密标识ID，备用（将原样返回给客户端）。
5. 服务器打包自己的自签名证书和客户端标识ID，加密传递给客户端。
6. 客户端解密证书和标识ID，验证标识ID是否匹配，证实当次会话的准确性（这是一个冗余，解密能成功就证明了对端拥有私钥）。
7. 客户端信任该自签名证书，重新连接服务器，完成可靠的TLS安全连接。


#### 公钥广播与验证

组网节点在保留对端分享来的节点信息（地址+公钥）时，应当对分享节点的公钥执行验证，避免恶意节点篡改分享节点的公钥并传播出来。

如果公钥验证失败，可以判定对方为恶意，加入临时黑名单。这样可以约束恶意节点的影响，并且让它们在网络中难以长时间存在（会受到正常节点的排挤）。

验证公钥采用尽量精简的方式：

- 连接目标节点，用共享密钥加密一个简单消息（随机值A），连同自己的公钥明文一起发送。
- 对端解密获取消息内容，重新加密发送一个回应消息（随机值A + 自身地址）。
- 本端解密回应消息，核实随机值A（以及对端地址），证实公钥确实属于对端所有。完成验证。



## 服务器群

服务器提供的区块链收益地址（stake address）通常需要客户端认可，才能收到实际的捐赠。

在区块链的捐赠机制中，一个公共服务器能得到铸币分红，需要区块链铸造者足够的认可标记。如果该服务器并不强大，它对区块链节点提供的服务很可能就可见性不高，得到的认可就很低，甚至没有认可。

因此，这里支持**服务器群**的概念：众多分散的服务器可以提供一个共同的收益地址，这样就可以极大的提升该地址在区块链网络中的可见性，得到足够的标记认可。另外，为便于区分服务器群里的各个成员，可以用一个**身份ID**来标识具体的服务器，为服务器群里成员的考评提供区分。

这是一种离散的组织机制，很自由很灵活。

不过一个服务器群也可以是有组织的，中心化管理分布式的节点。这一机制也同样适用。



------------------------------------------------------------------------------

## 注意事项

- Findings节点的信息可以本地暂存，以实现基于历史的IP发现。但不应长期保存。
