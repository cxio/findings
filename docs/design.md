# Findings设计

Findings是一个基础公共服务网络，提供各种P2P应用的同类节点发现和连接辅助（NAT打洞中介）。

Findings网络本身是P2P的，它由区块链应用的奖励提供运行的经济支撑。虽然理论上也可接收非区块链应用的捐助，但实际利益应该不大。

区块链应用是P2P的，节点发现是一个基础性需求。为避免初始节点中心化的脆弱性，一个遍布互联网的节点发现公共服务是有意义的。而区块链加密币的直接支付能力，为这一机制提供了前提保证。


## 组网规则

不同的Findings节点相互连接组成一个P2P网络，动态更新连接、切换，彼此交换必要的信息，运行为一个强壮的P2P服务网络。

每个节点在完成Findings组网的同时，也支持其它应用类型的节点连接，提供**NAT类型探测**和**打洞协助**（信令服务器）。

对于区块链类应用，服务器应当提供相同区块链类型的账户地址，接收可能有的区块链奖励（gratuity）。对于非区块链类应用，虽然理论上也可以提供某个流行区块链的账户地址来接收捐赠，但这可能意义不大。

服务器支持哪一类应用以及能提供什么账户地址，是在Findings节点上个性化配置的，它由节点自己做主。


### Findings节点组网

可接受直接连接的Findings节点需直接或间接位于公网之上（`Pub/FullC`），它们也是Findings网络主要交换的数据之一，这里简称为公网节点。公网节点之间的连接即为Findings组网。

通常情况下，一个应用可长时间运行一个本地Findings服务器（挂机），让它连接到Findings网络，交换获取其它公网节点，然后寻找支持本类型应用的其它Findings服务器。

Findings组网不支持连入位于NAT之后的节点（`RC/P-RC/Sym`），但它们可以连出到公网节点。

> **注：**
> 公网节点依然可以从连入的NAT受限节点获取其它公网节点的信息，这可以强化Findings网络的健壮性。


#### 公网节点信息

可直接连入的公网节点（`Pub/FullC`）相互之间通过TCP连接组网，彼此仅仅需要知道对方的IP地址和端口即可。

连接通常采用支持安全协议（`TLS/SSL`）的链路，虽然本网的P2P节点间并不需要相信对方（知道对方的证书），但安全协议本身可以避免外部第三方窥探和信息泄露，以及可能的信息分析及阻断。


#### 应用节点信息

应用节点连接Findings主网来获取NAT探测和UDP打洞协助服务。当前的主网暂不支持 TCP 的 TURN 中继服务。

应用节点需要提供如下的信息。

- 应用类型：depots:xx | blockchain:xx | applier:xx | findings:xx
- 支持协议：tcp | udp
- 公网地址：IP:Port
- NAT 层级：Pub | FullC | RC | P-RC | Sym

应用提供自身支持的协议类型（tcp|udp），可以方便同类节点决定自己的连接策略。作为同一种应用，它们知道自己的tcp或udp具体是哪一种连接方式（如 websocket 或 dtls）。

通常，只有可直连（Pub/FullC）的节点才会支持TCP，因为受限节点的TCP需要TURN中继服务。


#### 候选池

候选池暂存一些公网节点，它们都是可直接连通的。当节点进行连接切换的时候，会从候选池中随机抽取进行连接。

连接切换通常10分钟一次，一次切换1~2个节点。当与新的节点连接后，会获得对端的公网节点数据分享（对端候选池内信息）。新获得的节点信息会与当前节点的候选池混合：测试可连接性，排除无效和重复。然后从中优选以维持候选池原有规模。

> **参考：**
> 挑选原则：*低延迟优先，适当兼顾中高延迟节点，避免地域明显分割*。


#### 组网池

即维持Findings网络组网功能的节点连接池，仅支持 TCP 协议。组网池成员通常是公网节点，但通过TCP主动连入的受限节点并不能被识别，不过这并不构成问题。

组网池成员负责Findings网络的维系：动态更新连接、交换公网节点信息，以及 NAT 探测中的 `NewHost` 辅助服务。

> **注：**
> NAT受限节点虽然不能直接接受其它节点的连入以提供服务，但配合 `NewHost` 则没问题。


#### 应用池

接受其它各类应用节点的连入（含*findings*类型），提供NAT探测服务和其应用自身的 `UDP:STUN` 打洞协助服务。

位于NAT之后的Findings节点也可以以*findings类型*应用来连入公网节点，获得与其它同样位于NAT之后的Findings节点间的打洞服务。打洞连接仅能支持 UDP 协议。

> **注：**
> 能提供打洞服务的Findings节点只能是公网节点，因为只有它们能直接接收其它应用节点的连接。


#### 对应用的支持

每个Findings公网节点都能提供组网能力和NAT探测服务，但打洞服务所支持的应用类型则可能不同，这由节点自身的配置决定。

通常，一个应用节点会运行一个本地Findings服务器，通过该服务器获取其它Findings节点，然后筛选过滤得到支持本应用的Findings公网节点。这个局部的Findings服务器通常并不参与Findings组网，但它要通过UDP打洞连接其它同类型节点，则是它的自由。

> **注：**
> 作为NAT受限的Findings节点间的UDP打洞连接暂未实现（仅*公网节点信息分享*功能）。


#### 分享池

接受支持 TCP 直连的应用服务器节点的登记，方便其同类应用节点找到它而实现该应用的P2P连接组网。

这与登记 UDP 节点的应用池共同完成对第三方应用组网的全面支持。



------------------------------------------------------------------------------

## 注意事项

- 节点信息有本地暂存，但不应长期存储。
