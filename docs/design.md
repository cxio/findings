# Findings设计

Findings是一个基础公共服务网络，提供各种P2P应用的同类节点发现和连接辅助（NAT层级探测和打洞协助）。

Findings网络本身是P2P的，它由区块链应用的奖励提供运行的经济支撑。虽然理论上也可以接收非区块链应用的捐助，但实际效果可能不足。

区块链应用是P2P的，节点发现是一个基础性需求。为避免初始节点中心化的脆弱性，一个遍布互联网的节点发现公共服务是有意义的。而区块链加密币的直接支付能力，为这一机制提供了前提。


## 组网规则

不同的Findings节点相互连接组成一个P2P网络，动态更新连接、切换，彼此交换必要的信息，运行为一个强壮的P2P公共服务网络。

每个节点在完成Findings组网的同时，也支持其它应用类型的节点连接，提供**NAT类型探测**和**打洞协助**的信令服务。

对于区块链类应用，服务器应当提供相同区块链类型的账户地址，接收可能有的区块链奖励（gratuity）。对于非区块链类应用，服务器也可以提供一个流行区块链的账户地址来接收可能有的捐赠。

服务器支持哪一类应用以及能提供什么账户地址，是在Findings节点上个性化配置的，它由节点自己做主。


### 公网节点

可被直接连入的 `Pub/FullC` 类型节点，在这里我们称为公网节点。

在Findings网络中，公网节点之间通过TCP连接组网，连接采用安全协议（`TLS/SSL`）链路。P2P节点之间并不需要信任，无需知道对方的证书，采用安全协议是为了避免外部第三方窥探和分析。


### 应用节点

应用节点是除了Findings组网节点之外的所有类型的节点。它们连接Findings网络，获取NAT探测服务以及UDP打洞协助。

> **注：**
> 当前的Findings网络不提供 TCP 链路的 TURN 中继服务。

应用节点通常包含如下信息：

- 应用类型：depots:xx | blockchain:xx | applier:xx | findings:xx
- 公网地址：IP:Port
- NAT 层级：Pub | FullC | RC | P-RC | Sym

其中公网地址（IP:Port）在节点连接Findings网络后即可获知，如果节点不处于公网，可以请求NAT层级探测服务。如果节点还需要UDP打洞协助，则NAT层级探测是必需的。

本系统不支持TCP的TURN中继服务，作为一种折衷，这里支持TCP公网服务器的登记。这样，在TCP链路上，应用客户端就可以直接获取其服务器节点，这也是一种良好的便捷。

> **注：**
> 普通的Findings节点也可以作为应用节点申请NAT探测和打洞服务，如果它不是声明“组网”的话。


### Findings节点组网

Findings类节点相互连接、协作，动态地交换信息，维持Findings网络持续运行……就是Findings组网。

直接接受连入的Findings节点需位于公网之上（`Pub/FullC`），而如果只是连出，则没有这个限制（就像一个普通的Findings客户端一样）。通常情况下，一个应用可长时间运行一个本地的Findings客户端（挂机），让它连接到Findings网络，交换获取其它公网节点信息，然后寻找支持本类型应用的其它Findings服务器。

> **注：**
> 公网节点依然可以从连入的NAT受限节点获取其它公网节点的信息，这可以强化Findings网络的健壮性。


#### 候选池

候选池暂存一些Findings公网节点，当节点进行连接切换的时候，会从候选池中随机抽取进行连接。

连接切换通常几分钟一次，一次切换1~2个节点。当与新的节点连接后，会获得对端的候选池节点数据分享。新获得的节点会与当前节点的候选池混合：在可连接性测试和去重后，并入当前候选池。

> **参考：**
> 挑选原则：*低延迟优先，适当兼顾中高延迟节点，避免地域明显分割*。


#### 组网池

即维持Findings网络组网功能的节点连接池，仅支持 TCP 协议。组网池成员通常是公网节点，但通过TCP主动连入的受限节点并不能被识别，不过这不是问题。

组网池成员负责Findings网络的维系：动态更新连接、交换公网节点信息，以及 NAT 探测中的 `NewHost` 辅助服务。

> **注：**
> NAT受限节点虽然不能直接接受其它节点的连入以提供服务，但配合 `NewHost` 则没问题。


#### 应用池

接受其它各类应用节点的连入，提供NAT探测服务和其应用自身的 `UDP:STUN` 打洞协助服务。

位于NAT之后的Findings节点也可以以*findings类型*应用来连入公网节点，获得与其它同样位于NAT之后的Findings节点间的打洞服务。打洞连接仅能支持 UDP 协议。

> **注：**
> 能提供打洞服务的Findings节点只能是公网节点，因为只有它们能直接接收其它应用节点的连接。


#### 对应用的支持

每个Findings公网节点都能提供NAT探测服务，但打洞服务所支持的应用类型则可能不同，这由节点自身的配置决定。


#### 分享池

接受支持 TCP 可直连的应用服务器节点的登记，方便其同类应用节点找到它而实现该应用的P2P连接组网。



## 服务器群

服务器提供的区块链收益地址（stake address）通常需要客户端认可，才能收到实际的捐赠。

在区块链的捐赠机制中，一个公共服务器能得到铸币分红，需要区块链铸造者足够的认可标记。如果该服务器并不强大，它对区块链节点提供的服务很可能就可见性不高，得到的认可就很低，甚至没有认可。

因此，这里支持**服务器群**的概念：众多分散的服务器可以提供一个共同的地址，同时提供一个**身份ID**来标识自己。这样，该收益地址就可以极大的提升其在区块链网络中的可见性，得到区块链应用中足够的标记认可，从而完成分红。

这是一种离散的组织机制，很自由很灵活。

不过一个服务器群也可以是有组织的，中心化管理分布式的节点。这一机制也同样适用。



------------------------------------------------------------------------------

## 注意事项

- 节点信息有本地暂存，但不应长期存储。
